version: 2

models:
  - name: bans
    description: KPIs for Dashboard Overview Page
    columns:
      - name: upcoming_games
        description: data_testsNumber of upcoming gamesdata_tests
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: true

      - name: upcoming_game_date
        description: "Date of the next upcoming game"
        data_tests:
          - not_null

      - name: location
        description: "Game location"
        data_tests:
          - not_null
          - accepted_values:
              values: ["Home", "Away"]

      - name: tot_wins
        description: "Total wins"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: true

      - name: games_played
        description: "Total games played"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: true

      - name: avg_pts
        description: "Average points per game"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: true

      - name: last_yr_ppg
        description: "Last year's points per game"
        data_tests:
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: true

      - name: scrape_time
        description: "When data was scraped"

      - name: win_pct
        description: "Win percentage"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              inclusive: true

      - name: league_ts_percent
        description: "League true shooting percentage"
        data_tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              inclusive: true

      - name: last_updated_at
        description: "Timestamp of last update"
        data_tests:
          - not_null

      - name: sum_active_protocols
        description: "Sum of active protocols"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: true

    data_tests:
      - dbt_utils.expression_is_true:
          expression: "tot_wins <= games_played"
          name: wins_cannot_exceed_games_played

      - dbt_utils.expression_is_true:
          expression: "win_pct = ROUND(tot_wins::numeric / NULLIF(games_played, 0), 4) OR games_played = 0"
          name: win_pct_calculated_correctly

      - dbt_expectations.expect_table_row_count_to_equal:
          value: 2
